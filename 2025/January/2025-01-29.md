## This is a overview of configuring one-way SSL between Tomcat and Keycloak. 

1. Keycloak Keystore

* To generate a keystore for Keycloak:

```bash
$JAVA_HOME/bin/keytool -genkeypair -alias keycloak -keyalg RSA -keysize 2048 -validity 365 \
-keystore keycloak-keystore.jks -storepass password -keypass password
```
* For a more specific configuration:

```bash
$JAVA_HOME/bin/keytool -genkeypair -alias keycloak -keyalg RSA -keysize 2048 -validity 365 \
-keystore keycloak-keystore.jks -storepass password -keypass password \
-dname "CN=<KEYCLOAK_IP>, OU=<ORG>, O=<ORG_NAME>, L=<CITY>, ST=<STATE>, C=<COUNTRY>" \
-ext SAN=DNS:localhost,IP:<KEYCLOAK_IP>
```

2. Keycloak Certificate Export :
* To export the Keycloak public certificate:

```bash
$JAVA_HOME/bin/keytool -export -alias keycloak -file keycloak-public-cert.crt \
-keystore keycloak-keystore.jks -storepass password
```
3. Tomcat Keystore Generation
* Similarly, generate a keystore for Tomcat:

```bash
$JAVA_HOME/bin/keytool -genkeypair -alias tomcat -keyalg RSA -keysize 2048 -validity 365 \
-keystore tomcat-keystore.jks -storepass password -keypass password
```
* For specific configuration:

```bash
$JAVA_HOME/bin/keytool -genkeypair -alias tomcat -keyalg RSA -keysize 2048 -validity 365 \
-keystore tomcat-keystore.jks -storepass password -keypass password \
-dname "CN=<TOMCAT_IP>, OU=<ORG>, O=<ORG_NAME>, L=<CITY>, ST=<STATE>, C=<COUNTRY>" \
-ext SAN=DNS:localhost,IP:<TOMCAT_IP>
```

4. Tomcat Certificate Export
* Export the Tomcat public certificate:

```bash
$JAVA_HOME/bin/keytool -export -alias tomcat -file tomcat-public-cert.crt \
-keystore tomcat-keystore.jks -storepass password
```
5. Import Keycloak's Certificate into Tomcat's Truststore
* Import Keycloak's certificate into Tomcat's truststore:

```bash
$JAVA_HOME/bin/keytool -import -trustcacerts -alias keycloak -file keycloak-public-cert.crt \
-keystore tomcat-truststore.jks -storepass password
```
6. Keycloak Configuration (keycloak.conf)
* Add SSL configurations to Keycloak's keycloak.conf:

```conf

hostname=localhost
https-listener-enabled=true
https-port=9443
https-client-auth=none
https-key-store-file=/path/to/keycloak-keystore.jks
https-key-store-password=password
```

7. Tomcat SSL Configuration (server.xml)
* Add the following to server.xml:

```xml

<Connector port="8443" protocol="org.apache.coyote.http11.Http11NioProtocol"
      maxThreads="200" SSLEnabled="true" clientAuth="false">
    <UpgradeProtocol className="org.apache.coyote.http2.Http2Protocol" />
    <SSLHostConfig>
        <Certificate certificateKeystoreFile="conf/tomcat-keystore.jks"
                     certificateKeystorePassword="password" />
        <Truststore certificateKeystoreFile="conf/tomcat-truststore.jks"
                    certificateKeystorePassword="password" />
    </SSLHostConfig>
</Connector>
```

8. Tomcat Truststore Configuration in catalina.sh
* Update the Tomcat catalina.sh to specify the truststore:

```bash
JAVA_OPTS="$JAVA_OPTS -Djavax.net.ssl.trustStore=/path/to/tomcat-truststore.jks"
JAVA_OPTS="$JAVA_OPTS -Djavax.net.ssl.trustStorePassword=password"
```

9. Keycloak Client Configurations for HTTPS
* To update client configurations in Keycloak, log into the admin console and ensure the settings for URLs use HTTPS.
* add following to apache http.conf file:

```conf
<VirtualHost *:443>
    ServerName enum.hsenidmobile.com
    ServerAlias www.enum.hsenidmobile.com

    # SSL Certificate Files
    SSLEngine On
    SSLCertificateFile /hms/installs/apache/key/enum_hsenidmobile_com.crt
    SSLCertificateKeyFile /hms/installs/apache/key/enum_hsenidmobile_com.key
    SSLCertificateChainFile /hms/installs/apache/key/enum_hsenidmobile_com.crt

    # Proxy Settings
    ProxyPreserveHost On
    ProxyRequests Off

    # Forward requests to Keycloak
    ProxyPass /admin-ui https://172.16.3.23:9443/admin-ui
    ProxyPassReverse /admin-ui https://172.16.3.23:9443/admin-ui

    ProxyPass / https://172.16.3.23:9443/
    ProxyPassReverse / https://172.16.3.23:9443/

    # Fix Cookie Paths for Reverse Proxy
    ProxyPassReverseCookiePath / /

    # Security Headers
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options nosniff
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Content-Security-Policy "default-src 'self' https:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

    # Logging (optional)
    ErrorLog ${APACHE_LOG_DIR}/reverse-proxy-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/reverse-proxy-ssl-access.log combined
</VirtualHost>

<VirtualHost *:80>
    ServerName enum.hsenidmobile.com
    ServerAlias www.enum.hsenidmobile.com

    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} !=on
    RewriteRule ^/(.*)$ https://enum.hsenidmobile.com/$1 [R=301,L]

    # Logging (optional)
    ErrorLog ${APACHE_LOG_DIR}/reverse-proxy-error.log
    CustomLog ${APACHE_LOG_DIR}/reverse-proxy-access.log combined
</VirtualHost>


```
10. Tomcat Admin UI Configuration
* Update the URLs for the admin UI in admin-ui.properties:

```conf
spring.security.oauth2.client.logout.keycloak.base.url=https://localhost:9443/realms/<REALM>/protocol/openid-connect/logout
spring.security.oauth2.client.provider.keycloak.token-uri=https://localhost:9443/realms/<REALM>/protocol/openid-connect/token
spring.security.oauth2.client.provider.keycloak.jwk.set.uri=https://localhost:9443/realms/<REALM>/protocol/openid-connect/certs
spring.security.oauth2.client.provider.keycloak.authorization.uri=https://localhost:9443/realms/<REALM>/protocol/openid-connect/auth
```
